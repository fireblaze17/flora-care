<!DOCTYPE html>
<html>
<head>
    <title>Home Page</title>
    <style>
        .plant-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .plant-box {
            border: 1px solid #ccc;
            padding: 20px;
            width: 200px;
            box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .plant-box button {
            margin-top: 10px;
        }
        .red {
            background-color: red;
        }
    </style>
</head>
<body>
    <h2>Welcome to the Homepage!</h2>
    <form action="{{ url_for('plantadd') }}" method="get">
        <button type="submit">Add Plant</button>
    </form>

    <!-- Search Form -->
    <form action="{{ url_for('search_plants') }}" method="get">
        <input type="text" name="query" placeholder="Search for plants..." style="margin-top: 20px;">
        <button type="submit">Search</button>
    </form>

    <div class="plant-container">
        {% for plant in plants %}
        <div class="plant-box" id="plant-{{ plant[0] }}">
            <h3>{{ plant[1] }}</h3> <!-- Plant name -->
            <p>Location: {{ plant[2] }}</p> <!-- Plant location -->
            <p>Watering Frequency: {{ plant[3] }} hours</p> <!-- Watering frequency -->
            <form action="{{ url_for('editplant', plant_id=plant[0]) }}" method="get">
                <button type="submit">Edit Plant</button>
            </form>
            <form action="{{ url_for('deleteplant', plant_id=plant[0]) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this plant?');">
                <button type="submit">Delete Plant</button>
            </form>
            <button onclick="resetTimer({{ plant[0] }}, {{ plant[3] }})">Reset Timer</button>
            <button>Check Plant Health</button>
        </div>
        {% endfor %}
    </div>

    <script>
        let timers = {};

        function saveTimerState(plantId, lastResetTime) {
            localStorage.setItem(`plant_${plantId}_last_reset`, lastResetTime);
        }

        function getTimerState(plantId) {
            return localStorage.getItem(`plant_${plantId}_last_reset`);
        }

        function resetTimer(plantId, frequency) {
            fetch(`/reset_timer/${plantId}`, {
                method: 'POST'
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      const plantBox = document.getElementById('plant-' + plantId);
                      plantBox.classList.remove('red');
                      if (timers[plantId]) {
                          clearTimeout(timers[plantId]);
                      }
                      timers[plantId] = setTimeout(() => {
                          plantBox.classList.add('red');
                      }, frequency * 60 * 1000); // Convert hours to milliseconds

                      // Save the last reset time to local storage
                      saveTimerState(plantId, new Date().toISOString());

                      // Update the server to mark as reset
                      fetch(`/update_plant_state/${plantId}`, {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'}
                      }).then(response => response.json())
                        .then(data => {
                            if (data.status !== 'success') {
                                console.error(data.message);
                            }
                        }).catch(error => console.error('Error:', error));
                  } else {
                      console.error(data.message);
                  }
              }).catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const plantData = {{ plants|tojson|safe }};

            plantData.forEach(plant => {
                const plantId = plant[0];
                const frequency = plant[3];
                const savedLastReset = getTimerState(plantId);

                fetch(`/get_last_reset/${plantId}`, {
                    method: 'GET'
                }).then(response => response.json())
                  .then(data => {
                      if (data.status === 'success') {
                          const lastResetTime = savedLastReset ? new Date(savedLastReset).getTime() : new Date(data.last_reset).getTime();
                          const currentTime = Date.now();
                          const elapsedTime = currentTime - lastResetTime;
                          const remainingTime = (frequency * 60 * 1000) - elapsedTime;

                          const plantBox = document.getElementById('plant-' + plantId);

                          if (remainingTime <= 0) {
                              plantBox.classList.add('red');
                          } else {
                              timers[plantId] = setTimeout(() => {
                                  plantBox.classList.add('red');
                              }, remainingTime);
                          }
                      } else {
                          console.error(data.message);
                      }
                  }).catch(error => console.error('Error:', error));
            });
        });
    </script>
</body>
</html>
